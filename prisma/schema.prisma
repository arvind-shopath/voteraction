generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Assembly {
  id                    Int                      @id @default(autoincrement())
  number                Int                      @unique
  name                  String
  district              String
  state                 String                   @default("Uttar Pradesh")
  candidateName         String?
  candidateImageUrl     String?
  party                 String                   @default("Independent")
  themeColor            String                   @default("#1E3A8A")
  logoUrl               String?
  facebookUrl           String?
  instagramUrl          String?
  twitterUrl            String?
  prevPartyVotes        Int                      @default(0)
  prevCandidateVotes    Int                      @default(0)
  totalVoters           Int                      @default(0)
  totalBooths           Int                      @default(0)
  historicalResults     String?
  casteEquation         String?
  enabledFeatures       String?
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt
  electionDate          DateTime?
  lastElectionDate      DateTime?
  nextElectionDate      DateTime?
  campaignTags          String?
  candidateBusiness     String?
  importantAreas        String?
  importantCastes       String?
  importantIssues       String?
  importantNewspapers   String?
  booths                Booth[]
  campaigns             Campaign[]
  campaignMaterials     CampaignMaterial[]
  candidatePostRequests CandidatePostRequest[]
  electionHistory       ElectionHistory[]
  importJobs            ImportJob[]
  issues                Issue[]
  jansamparkRoutes      JansamparkRoute[]
  publicRelations       PublicRelation[]
  socialMediaApprovals  SocialMediaApproval[]
  socialPosts           SocialPost[]
  systemLogs            SystemLog[]
  tasks                 Task[]
  users                 User[]
  sharedAssignments     UserAssemblyAssignment[]
  voters                Voter[]
  workers               Worker[]
  workerJanSamparks     WorkerJanSampark[]
  workerSocialTasks     WorkerSocialTask[]
  centralContentTasks   CentralContentTask[]
  voterEditRequests     VoterEditRequest[]

  @@index([number])
}

model Campaign {
  id             Int             @id @default(autoincrement())
  name           String
  candidateName  String?
  assemblyId     Int
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  assembly       Assembly        @relation(fields: [assemblyId], references: [id])
  users          User[]
  voterFeedbacks VoterFeedback[]
  workers        Worker[]

  @@index([assemblyId])
}

model PublicRelation {
  id          Int      @id @default(autoincrement())
  location    String
  visitDate   DateTime @default(now())
  description String?
  atmosphere  String?
  assemblyId  Int
  createdBy   String?
  createdAt   DateTime @default(now())
  assembly    Assembly @relation(fields: [assemblyId], references: [id])
}

model JansamparkRoute {
  id              Int               @id @default(autoincrement())
  date            DateTime          @default(now())
  assemblyId      Int
  posterMade      Boolean           @default(false)
  posterMadeAt    DateTime?
  posterMadeBy    Int?
  posterNotNeeded Boolean           @default(false)
  posterStatus    String?
  createdAt       DateTime          @default(now())
  posterUser      User?             @relation(fields: [posterMadeBy], references: [id])
  assembly        Assembly          @relation(fields: [assemblyId], references: [id])
  visits          JansamparkVisit[]
}

model JansamparkVisit {
  id         Int             @id @default(autoincrement())
  village    String
  time       String?
  atmosphere String?
  notes      String?
  routeId    Int
  route      JansamparkRoute @relation(fields: [routeId], references: [id])
}

model User {
  id                    Int                      @id @default(autoincrement())
  email                 String?                  @unique
  emailVerified         DateTime?
  image                 String?
  username              String?                  @unique
  password              String?
  role                  String                   @default("CANDIDATE")
  status                String                   @default("Pending")
  expiryDate            DateTime?
  assemblyId            Int?
  campaignId            Int?
  name                  String?
  mobile                String?
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt

  // Personal Branding (moved from Assembly or added)
  facebookUrl           String?
  instagramUrl          String?
  twitterUrl            String?

  accounts              Account[]
  campaignMaterials     CampaignMaterial[]       @relation("CampaignMaterials")
  acceptedPostRequests  CandidatePostRequest[]   @relation("AcceptedPostRequests")
  candidatePostRequests CandidatePostRequest[]   @relation("CandidatePostRequests")
  posterRoutes          JansamparkRoute[]
  sessions              Session[]
  approvedContent       SocialMediaApproval[]    @relation("ApprovedContent")
  createdApprovals      SocialMediaApproval[]    @relation("CreatedApprovals")
  systemLogs            SystemLog[]
  campaign              Campaign?                @relation(fields: [campaignId], references: [id])
  assembly              Assembly?                @relation(fields: [assemblyId], references: [id])
  sharedAssignments     UserAssemblyAssignment[]
  socialSessions        SocialSession[]
  designerTasks         CentralContentTask[]     @relation("DesignerTasks")
  managerTasks          CentralContentTask[]     @relation("ManagerTasks")
  candidateCentralTasks CentralContentTask[]     @relation("CandidateCentralTasks")
  worker                Worker?
}

model Account {
  id                Int     @id @default(autoincrement())
  userId            Int
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           Int      @id @default(autoincrement())
  sessionToken String   @unique
  userId       Int
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SystemLog {
  id         Int       @id @default(autoincrement())
  action     String
  details    String?
  userId     Int?
  assemblyId Int?
  createdAt  DateTime  @default(now())
  user       User?     @relation(fields: [userId], references: [id])
  assembly   Assembly? @relation(fields: [assemblyId], references: [id])
}

model Voter {
  id             Int             @id @default(autoincrement())
  name           String
  age            Int?
  gender         String?
  relativeName   String?
  relationType   String?
  houseNumber    String?
  familySize     Int             @default(1)
  epic           String?         @unique
  boothNumber    Int?
  village        String?
  area           String?
  caste          String?
  subCaste       String?
  surname        String?
  supportStatus  String          @default("Neutral")
  notes          String?
  mobile         String?
  isVoted        Boolean         @default(false)
  isHead         Boolean         @default(false)
  isPwD          Boolean         @default(false)
  isImportant    Boolean         @default(false)
  verificationStatus String          @default("VERIFIED")
  eciStatus          String          @default("IN_LIST")
  status         String          @default("Active")
  updatedByName  String?
  assemblyId     Int
  importJobId    Int?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  pannaPramukhId Int?
  votedSentiment String?         // Legacy: for Support/Oppose/Neutral
  votedPartyId   Int?            // New: Link to specific Party
  importJob      ImportJob?      @relation(fields: [importJobId], references: [id])
  assembly       Assembly        @relation(fields: [assemblyId], references: [id])
  pannaPramukh   Worker?         @relation("PannaPramukhVoters", fields: [pannaPramukhId], references: [id])
  votedParty     Party?          @relation(fields: [votedPartyId], references: [id])
  feedbacks      VoterFeedback[]

  @@index([boothNumber])
  @@index([pannaPramukhId])
  @@index([surname])
  @@index([caste])
  @@index([village])
  @@index([assemblyId])
  @@index([importJobId])
  @@index([votedPartyId])
  editRequests VoterEditRequest[]
}

model VoterFeedback {
  id            Int      @id @default(autoincrement())
  voterId       Int
  campaignId    Int
  supportStatus String   @default("Neutral")
  verificationStatus String          @default("VERIFIED")
  eciStatus          String          @default("IN_LIST")
  notes         String?
  isVoted       Boolean  @default(false)
  status        String   @default("Active")
  mobile        String?
  votedSentiment String?         // Added for Poll Day Tracking
  updatedByName String?
  votedPartyId  Int?            // New: Link to specific Party
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  campaign      Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  voter         Voter    @relation(fields: [voterId], references: [id], onDelete: Cascade)
  votedParty    Party?   @relation(fields: [votedPartyId], references: [id])

  @@unique([voterId, campaignId])
}

model Booth {
  id                Int      @id @default(autoincrement())
  number            Int
  name              String?
  area              String?
  totalVoters       Int      @default(0)
  coveragePercent   Int      @default(0)
  status            String   @default("Medium")
  inchargeName      String?
  inchargeMobile    String?
  historicalResults String?
  casteEquation     String?
  turnout           Float    @default(0)    // Added for Poll Day Live Turnout
  turnoutHistory    String?                 // Added for Poll Day (JSON list of hourly %s)
  boothStatus       String   @default("Normal") // Added for Poll Day Alerts (Normal/Alert)
  assemblyId        Int
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  assembly          Assembly @relation(fields: [assemblyId], references: [id])
  workers           Worker[]

  @@unique([number, assemblyId])
}

model Worker {
  id                Int                @id @default(autoincrement())
  name              String
  mobile            String?            @unique
  type              String             @default("FIELD")
  userId            Int?               @unique
  boothId           Int?
  housesCovered     Int                @default(0)
  attendanceRate    Int                @default(0)
  performanceScore  Int                @default(0)
  totalPoints       Int                @default(0)
  assemblyId        Int
  campaignId        Int?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  deletedAt         DateTime?
  tasks             Task[]
  assignedVoters    Voter[]            @relation("PannaPramukhVoters")
  user              User?              @relation(fields: [userId], references: [id])
  booth             Booth?             @relation(fields: [boothId], references: [id])
  campaign          Campaign?          @relation(fields: [campaignId], references: [id])
  assembly          Assembly           @relation(fields: [assemblyId], references: [id])
  workerJanSamparks WorkerJanSampark[]
  socialTasks       WorkerSocialTask[]
  pointLogs         WorkerPointLog[]
  editRequests      VoterEditRequest[]

  @@index([assemblyId])
}

model WorkerPointLog {
  id          Int      @id @default(autoincrement())
  workerId    Int
  points      Int
  action      String
  description String?
  createdAt   DateTime @default(now())
  worker      Worker   @relation(fields: [workerId], references: [id])

  @@index([workerId])
}

model Task {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  status      String    @default("Pending")
  priority    String    @default("Medium")
  dueDate     DateTime?
  workerId    Int
  assemblyId  Int
  report      String?
  mediaUrls   String?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  worker      Worker    @relation(fields: [workerId], references: [id])
  assembly    Assembly  @relation(fields: [assemblyId], references: [id])

  @@index([workerId])
  @@index([assemblyId])
}

model Issue {
  id            Int      @id @default(autoincrement())
  title         String
  description   String?
  category      String?
  priority      String   @default("Medium")
  status        String   @default("Open")
  boothNumber   Int?
  reportedBy    String?
  daysPending   Int      @default(0)
  assemblyId    Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  updatedByName String?
  area          String?
  mediaUrls     String?
  videoUrl      String?
  village       String?
  assembly      Assembly @relation(fields: [assemblyId], references: [id])

  @@index([assemblyId])
}

model SocialPost {
  id              Int       @id @default(autoincrement())
  content         String
  imageUrl        String?
  status          String    @default("Draft")
  postType        String    @default("Post")
  platform        String?
  assemblyId      Int
  createdBy       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  publishedAt     DateTime?
  eventName       String?
  importantPeople String?
  location        String?
  mediaUrls       String?
  videoUrl        String?
  liveLink        String?
  externalId      String?
  assembly        Assembly  @relation(fields: [assemblyId], references: [id])

  @@index([assemblyId])
  @@index([status])
  @@index([postType])
}

model ImportJob {
  id            Int       @id @default(autoincrement())
  fileName      String
  filePath      String
  status        String    @default("PENDING")
  progress      Int       @default(0)
  assemblyId    Int
  boothNumber   Int?
  boothName     String?
  commonAddress String?
  expectedCount Int?
  startPage     Int?
  endPage       Int?
  totalVoters   Int       @default(0)
  errorMessage  String?
  logs          String?
  addedAt       DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  completedAt   DateTime?
  assembly      Assembly  @relation(fields: [assemblyId], references: [id])
  voters        Voter[]
}

model WorkerJanSampark {
  id          Int      @id @default(autoincrement())
  personName  String
  mobile      String?
  village     String?
  description String?
  imageUrl    String?
  atmosphere  String?  @default("Neutral")
  workerId    Int
  assemblyId  Int
  voterId     Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  assembly    Assembly @relation(fields: [assemblyId], references: [id])
  worker      Worker   @relation(fields: [workerId], references: [id])
}

model Party {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  color     String   @default("#1E3A8A")
  logo      String?
  createdAt DateTime @default(now())
  voters    Voter[]
  feedbacks VoterFeedback[]
}

model ElectionHistory {
  id             Int      @id @default(autoincrement())
  year           Int
  candidateName  String
  partyName      String
  votesReceived  Int
  votePercentage Float?
  totalVotes     Int?
  result         String?
  margin         Int?
  assemblyId     Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  assembly       Assembly @relation(fields: [assemblyId], references: [id])

  @@index([assemblyId])
  @@index([year])
}

model CandidatePostRequest {
  id              Int                @id @default(autoincrement())
  subject         String
  location        String
  importantPeople String?
  description     String?
  photoUrls       String?
  videoUrls       String?
  postType        String             @default("Post")
  status          String             @default("PENDING")
  facebookUrl     String?
  twitterUrl      String?
  instagramUrl    String?
  whatsappUrl     String?
  publishedAt     DateTime?
  assemblyId      Int
  createdBy       Int
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  acceptedAt      DateTime?
  acceptedBy      Int?
  acceptor        User?              @relation("AcceptedPostRequests", fields: [acceptedBy], references: [id])
  creator         User               @relation("CandidatePostRequests", fields: [createdBy], references: [id])
  assembly        Assembly           @relation(fields: [assemblyId], references: [id])
  workerTasks     WorkerSocialTask[]

  @@index([assemblyId])
  @@index([status])
  @@index([createdAt])
}

model SocialMediaApproval {
  id              Int       @id @default(autoincrement())
  title           String
  contentType     String
  mediaUrls       String
  notes           String?
  status          String    @default("PENDING")
  assemblyId      Int
  createdBy       Int
  approvedBy      Int?
  createdAt       DateTime  @default(now())
  approvedAt      DateTime?
  rejectionReason String?
  postedUrls      String?
  postedAt        DateTime?
  approver        User?     @relation("ApprovedContent", fields: [approvedBy], references: [id])
  creator         User      @relation("CreatedApprovals", fields: [createdBy], references: [id])
  assembly        Assembly  @relation(fields: [assemblyId], references: [id])

  @@index([assemblyId])
  @@index([status])
}

model CampaignMaterial {
  id           Int                @id @default(autoincrement())
  title        String
  description  String?
  materialType String
  fileUrls     String
  platform     String             @default("ALL")
  expiresAt    DateTime?
  assemblyId   Int
  createdBy    Int
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  creator      User               @relation("CampaignMaterials", fields: [createdBy], references: [id])
  assembly     Assembly           @relation(fields: [assemblyId], references: [id])
  workerTasks  WorkerSocialTask[]

  @@index([assemblyId])
  @@index([createdAt])
}

model WorkerSocialTask {
  id                 Int                     @id @default(autoincrement())
  taskType           String
  postRequestId      Int?
  campaignMaterialId Int?
  workerId           Int
  assemblyId         Int
  dueDate            DateTime
  liked              Boolean                 @default(false)
  likedAt            DateTime?
  shared             Boolean                 @default(false)
  sharedAt           DateTime?
  commented          Boolean                 @default(false)
  commentedAt        DateTime?
  sharedOnWhatsapp   Boolean                 @default(false)
  sharedOnFacebook   Boolean                 @default(false)
  sharedOnInstagram  Boolean                 @default(false)
  status             String                  @default("PENDING")
  completedAt        DateTime?
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  campaignMaterial   CampaignMaterial?       @relation(fields: [campaignMaterialId], references: [id])
  postRequest        CandidatePostRequest?   @relation(fields: [postRequestId], references: [id])
  assembly           Assembly                @relation(fields: [assemblyId], references: [id])
  worker             Worker                  @relation(fields: [workerId], references: [id])
  proofs             WorkerSocialTaskProof[]

  @@index([workerId])
  @@index([status])
  @@index([dueDate])
}

model WorkerSocialTaskProof {
  id            Int              @id @default(autoincrement())
  taskId        Int
  proofType     String
  screenshotUrl String
  createdAt     DateTime         @default(now())
  expiresAt     DateTime
  task          WorkerSocialTask @relation(fields: [taskId], references: [id])

  @@index([taskId])
  @@index([expiresAt])
}

model SocialSession {
  id          Int      @id @default(autoincrement())
  platform    String
  candidateId Int
  sessionData String
  updatedBy   Int
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  // Locking Mechanism to prevent multiple-IP bans
  lockedById  Int?
  lockedAt    DateTime?

  user        User @relation(fields: [candidateId], references: [id])

  @@unique([platform, candidateId])
  @@index([candidateId])
}

model UserAssemblyAssignment {
  id         Int      @id @default(autoincrement())
  userId     Int
  assemblyId Int
  role       String
  assignedAt DateTime @default(now())
  assembly   Assembly @relation(fields: [assemblyId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, assemblyId, role])
  @@index([userId])
  @@index([assemblyId])
  @@index([role])
}

model Notification {
  id          Int      @id @default(autoincrement())
  title       String
  message     String
  type        String   @default("INFO")
  isRead      Boolean  @default(false)
  userId      Int?
  assemblyId  Int?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([assemblyId])
  @@index([isRead])
}

model PushSubscription {
  id        Int      @id @default(autoincrement())
  userId    Int
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  @@index([userId])
}

model CentralContentTask {
  id                Int      @id @default(autoincrement())
  title             String?
  instructions      String?
  inputMediaUrls    String?  // Photos/videos provided by Manager (comma separated URLs)
  outputMediaUrls   String?  // Result from Designer/Editor (comma separated URLs)
  
  status            String   @default("ASSIGNED") // ASSIGNED, SUBMITTED, CORRECTION_REQUESTED, REJECTED_BY_MANAGER, APPROVED_BY_MANAGER, SENT_TO_CANDIDATE, APPROVED_BY_CANDIDATE, REJECTED_BY_CANDIDATE
  feedback          String?
  
  designerId        Int?     // User ID of the Designer/Editor
  managerId         Int      // User ID of the Manager/Admin who created it
  candidateId       Int?     // User ID of the target Candidate (once sent)
  assemblyId        Int?     // Target assembly
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  designer          User?    @relation("DesignerTasks", fields: [designerId], references: [id])
  manager           User     @relation("ManagerTasks", fields: [managerId], references: [id])
  candidate         User?    @relation("CandidateCentralTasks", fields: [candidateId], references: [id])
  assembly          Assembly? @relation(fields: [assemblyId], references: [id])

  @@index([designerId])
  @@index([managerId])
  @@index([candidateId])
  @@index([status])
}

model VoterEditRequest {
  id          Int      @id @default(autoincrement())
  voterId     Int
  workerId    Int
  assemblyId  Int
  changes     String   // JSON string
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  voter       Voter    @relation(fields: [voterId], references: [id])
  worker      Worker   @relation(fields: [workerId], references: [id])
  assembly    Assembly @relation(fields: [assemblyId], references: [id])

  @@index([assemblyId])
  @@index([status])
}

model CloudFile {
  id              String      @id @default(cuid())
  fileName        String
  fileSize        Int
  mimeType        String
  provider        String      @default("GOOGLE_DRIVE")
  externalId      String      // ID on Google Drive/Mega
  proxiedUrl      String?     // Optional: cache the local proxy URL
  expiresAt       DateTime
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([expiresAt])
  @@index([externalId])
}
model SystemSettings {
  id                Int      @id @default(autoincrement())
  key               String   @unique
  value             String
  description       String?
  updatedBy         Int?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([key])
}
